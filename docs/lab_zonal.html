<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GEOU9SP GIS Workbook - 12&nbsp; Lab 12 - Zonal Statistics and Overlap Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./sec_w8_spatial_analysis_III.html" rel="next">
<link href="./lab_joins.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./sec_w6_spatial_analysis_II.html">Week 6 - Spatial analysis II</a></li><li class="breadcrumb-item"><a href="./lab_zonal.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab 12 - Zonal Statistics and Overlap Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">GEOU9SP GIS Workbook</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w1_intro_toGIS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 1 - Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Lab 1: QGIS overview and file management</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_crs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Lab 2: Coordinate Reference Systems</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w2_vectors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 2 - Vector data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_vectors_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Lab 3: Working with vector attributes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_vectors_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Lab 4: Working with vector geometries</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w3_rasters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 3 - Raster data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_rasters_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Lab 5: Working with raster data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_rasters_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Lab 6: The raster calculator and other rastery bits</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w4_cartography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 4 - Making maps</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_carto_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Lab 7: Making Maps - Part I</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_carto_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Lab 8: Making Maps - Part II</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w5_spatial_analysis_I.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 5 - Spatial analysis I</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_catchup1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Lab 9 - Catch Up / Assignment Work session</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_geoprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Lab 10: Geoprocessing tools</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w6_spatial_analysis_II.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 6 - Spatial analysis II</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_joins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Lab 11 - Data Joins</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_zonal.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab 12 - Zonal Statistics and Overlap Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w8_spatial_analysis_III.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 8 - Spatial analysis III</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_dist_dens.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Lab 13 - Densities and distances</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_convex_interp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Lab 14 - Convex Hulls</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Week 10 - Obtaining spatial data in the field</span></span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#guided-exercise-1---data-preparation" id="toc-guided-exercise-1---data-preparation" class="nav-link active" data-scroll-target="#guided-exercise-1---data-preparation"><span class="header-section-number">12.1</span> Guided Exercise 1 - Data preparation</a></li>
  <li><a href="#guided-exercise-2---zonal-statistics" id="toc-guided-exercise-2---zonal-statistics" class="nav-link" data-scroll-target="#guided-exercise-2---zonal-statistics"><span class="header-section-number">12.2</span> Guided Exercise 2 - Zonal Statistics</a></li>
  <li><a href="#guided-exercise-3---overlap-analysis" id="toc-guided-exercise-3---overlap-analysis" class="nav-link" data-scroll-target="#guided-exercise-3---overlap-analysis"><span class="header-section-number">12.3</span> Guided Exercise 3 - Overlap Analysis</a></li>
  <li><a href="#guided-exercise---sample-raster-values" id="toc-guided-exercise---sample-raster-values" class="nav-link" data-scroll-target="#guided-exercise---sample-raster-values"><span class="header-section-number">12.4</span> Guided Exercise - Sample Raster Values</a></li>
  <li><a href="#independent-exercise---taiwanese-hemlock-and-climate-change" id="toc-independent-exercise---taiwanese-hemlock-and-climate-change" class="nav-link" data-scroll-target="#independent-exercise---taiwanese-hemlock-and-climate-change"><span class="header-section-number">12.5</span> Independent Exercise - Taiwanese hemlock and climate change</a>
  <ul class="collapse">
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background"><span class="header-section-number">12.5.1</span> Background</a></li>
  <li><a href="#data-acquisition" id="toc-data-acquisition" class="nav-link" data-scroll-target="#data-acquisition"><span class="header-section-number">12.5.2</span> Data Acquisition</a></li>
  <li><a href="#data-analysis" id="toc-data-analysis" class="nav-link" data-scroll-target="#data-analysis"><span class="header-section-number">12.5.3</span> Data Analysis</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./sec_w6_spatial_analysis_II.html">Week 6 - Spatial analysis II</a></li><li class="breadcrumb-item"><a href="./lab_zonal.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab 12 - Zonal Statistics and Overlap Analysis</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-spatan3" class="quarto-section-identifier"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab 12 - Zonal Statistics and Overlap Analysis</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>So far we have been mostly keeping to one of the two main data models: vectors and rasters. We have learned several ways to work with either, but they are mostly treated separately. The two exceptions are the <code>Mask by Layer</code> tool that lets us clip a raster based on a vector shape, and the <code>Polygonize</code> tool, which converts rasters into vectors.</p>
<p>In this lab you will learn about <code>Zonal Statistics</code> (<a href="https://docs.qgis.org/3.34/en/docs/user_manual/processing_algs/qgis/rasteranalysis.html#zonal-statistics">QGIS Documentation</a>), one of the main tools that mixes vectors and rasters, and lets you compute pixel statistics for regions defined by polygons. You will also learn about a related tool for points, called <code>Sample Raster Values</code> (<a href="https://docs.qgis.org/3.34/en/docs/user_manual/processing_algs/qgis/rasteranalysis.html#sample-raster-values">QGIS Documentation</a>), and a <code>cousin</code> tool to Zonal Statistics, the <code>Overlap Analysis</code> tool (<a href="https://docs.qgis.org/3.34/en/docs/user_manual/processing_algs/qgis/vectoranalysis.html#overlap-analysis">QGIS Documentation</a>).</p>
<section id="guided-exercise-1---data-preparation" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="guided-exercise-1---data-preparation"><span class="header-section-number">12.1</span> Guided Exercise 1 - Data preparation</h2>
<p>In this exercise, we will look at air pollution data from the city of <a href="https://en.wikipedia.org/wiki/Amsterdam">Amsterdam</a> in the Netherlands. Importantly for this exercise, Amsterdam is broken up into 8 districts or boroughs (stadsdelen), which are further divided into neighbourhoods (buurten).</p>
<p>More specifically, we will be looking at <a href="https://www.gov.uk/government/statistics/air-quality-statistics/ntrogen-dioxide">NO<span class="math inline">\(_2\)</span> (Nitrogen Dioxide) pollution</a>. NO<span class="math inline">\(_2\)</span> is mainly produced by combustion engines, and impacts respiratory health.</p>
<p>The data for this exercise has been pre-packaged and can be <a href="https://stir-my.sharepoint.com/:u:/g/personal/ala2_stir_ac_uk/ESlllBAgUyBJqNE2dGCSKkoBPKZlxKg-mTw8hjSkG0fpVA?e=Qg4Psg">downloaded here</a>, and it consists of the following datasets:</p>
<ul>
<li>A geopackage file containing four layers:
<ul>
<li>The location of several NO2 measurement sites, as point vectors.</li>
<li>The extent and location of parks and green spaces in Amsterdam, as a polygon vector layer.</li>
<li>The official boundaries of Amsterdam’s neighbourhoods, as polygon vectors.</li>
<li>A rectangular polygon defining the extent of the study.</li>
</ul></li>
<li>A CSV file containing annual NO<span class="math inline">\(_2\)</span> measurements for several sites, including the sites identified in the geopackage above.</li>
</ul>
<p>If you are curious, these files were obtained from the City of Amsterdam <a href="https://maps.amsterdam.nl/open_geodata/">geodata portal</a>.</p>
<ul>
<li>A raster file showing modelled annual NO2 concentrations for the year 2008, produced as an output from <a href="https://www.nature.com/articles/sdata201935">this research article</a>. The original files cover all of the Netherlands, but have been cropped to make the file size more manageable for this exercise.</li>
</ul>
<ol class="example" type="1">
<li>Download the data and create a project folder and a QGIS project for this exercise. The project should be set to EPSG:28992 - Amersfoort / RD New, the standard CRS for the Netherlands.</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Two useful websites to find information about coordinate reference systems are <a href="https://epsg.io/">https://epsg.io/</a> and <a href="https://spatialreference.org/">https://spatialreference.org/</a>. Search for EPSG:28992 in thee websites and see what information they provide.</p>
</div>
</div>
<ol start="2" class="example" type="1">
<li>Now load all five layers and the CSV file into your project. This CSV file has no coordinates, so you can just drag it to your <code>Layers</code> panel without needing to use the <code>Import Delimited Text</code> tool.</li>
</ol>
</section>
<section id="guided-exercise-2---zonal-statistics" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="guided-exercise-2---zonal-statistics"><span class="header-section-number">12.2</span> Guided Exercise 2 - Zonal Statistics</h2>
<p>You are now a GIS analyst at the Amsterdam city administration, and have been asked to analyse the pollution levels per city neighbourhood using the data for 2008 published by the scientific study above. Specifically, you have been asked to calculate the average NO<span class="math inline">\(_2\)</span> concentrations for each neighbourhood.</p>
<p>You have access to the neighbourhood boundaries in vector format, but the study data is given as a raster data.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Stop and Think">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stop and Think
</div>
</div>
<div class="callout-body-container callout-body">
<p>Using the GIS tools you have learned so far, how would you accomplish this?</p>
</div>
</div>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="Click for answer">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click for answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Since at this point we don’t know many tools that interface rasters and vectors, we would have to do it in a rather convoluted way. First, we would need to separate each neighbourhood into a separate vector file, and then mask the NO<span class="math inline">\(_2\)</span> raster multiple times to generate one pollution raster for each neighbourhood. We could then calculate the <code>Raster Layer Statistics</code> for each one of the masked neighbourhoods, and manually copy each average to a table. No big deal, there are only 518 neighbourhoods after all. There must be a better way - keep reading!</p>
<p>Still, this is a good example of how you can get by in GIS even with just basic knowledge and some creative thinking. There are always multiple ways to achieve the same result in GIS, even if some of these ways are not fast or optimal.</p>
</div>
</div>
</div>
<p>The right way to accomplish this task is to use the <code>Zonal Statistics</code> tool. It will calculate descriptive statistics (min, max, average, range, etc.) for raster values (pixels) contained within each polygon of a vector layer and output it as a new vector layer with the same polygons and attributes of the original vector layer, with added attribute columns for the statistics.</p>
<ol start="3" class="example" type="1">
<li><p>Go to the <code>Processing</code> panel and find the <code>Zonal statistics</code> tool (NOT <code>Raster layer zonal statistics</code>), under the <code>Raster analysis</code> category. It will launch a new window.</p></li>
<li><p>On the <code>Zonal Statistics</code> window, select the neighbourhoods layer as the <code>Input Layer</code>, and the NO<span class="math inline">\(_2\)</span> concentration map as the <code>Raster Layer</code>. Notice how you could select a specific band if your raster contained multiple bands. For <code>Output column prefix</code> write <code>NO2_</code> - this prefix will be added to the name of each calculated statistic to generate the new attributes. Right click on the <code>...</code> button to the right of the <code>Statistics to calculate</code> box to see which statistics are available for calculation. In this case we only want the means, so you can uncheck all other boxes. Then save your layer appropriately and <code>Run</code> then <code>Close</code>.</p></li>
</ol>
<p><img src="images/lab_12/lab12_fig1_zonastats.jpg" class="img-fluid"></p>
<ol start="5" class="example" type="1">
<li>Now style the new layer you obtained using a continuous colour scale to show NO<span class="math inline">\(_2\)</span> concentrations for each neighbourhood.</li>
</ol>
<p><img src="images/lab_12/lab12_fig_no2-per-neig.jpg" class="img-fluid"></p>
<ol start="6" class="example" type="1">
<li>Load the <code>OpenStreetMap</code> layer (on the <code>Browser Panel</code>, under the <code>XYZ Tiles</code> category). Does it look like NO<span class="math inline">\(_2\)</span> pollution is worse on densely urbanised areas?</li>
</ol>
</section>
<section id="guided-exercise-3---overlap-analysis" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="guided-exercise-3---overlap-analysis"><span class="header-section-number">12.3</span> Guided Exercise 3 - Overlap Analysis</h2>
<p>As you continue with your GIS analysis, you notice you have also been given a map with all the parks and green spaces in Amsterdam, and you wonder if they could be related to improved air quality. Maybe you could create an attribute that computed the amount of green spaces within each neighbourhood, and then use that information. You have two polygon vector layers now - one of the neighbourhoods and another of the green spaces.</p>
<div class="callout callout-style-default callout-important callout-titled" title="Stop and Think">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stop and Think
</div>
</div>
<div class="callout-body-container callout-body">
<p>Again, using the GIS tools you have learned so far, how would you accomplish this?</p>
</div>
</div>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="Click for answer">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click for answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>So far the tools we have learned for overlaying separate vector layers are the set of <em>geoprocessing</em> tools. You could calculate the <code>Intersection</code> of the green spaces and neighbourhoods layer - that would create a new layer showing only the extent of green spaces inside each neighbourhood. And because it is an intersection, you will carry all the attributes from both layers, including the neighbourhood names.</p>
<p>You could then use the <code>Field calculator</code> to calculate the area of green space for each neighbourhood from the intersection layer, and then use a <code>Join</code> to join these areas to the original neighbourhood layer, bringing in the green space area attribute. If you wanted a percentage instead of an area, you could then use the <code>Field calculator</code> again to divide the green space area by total neighbourhood area to get a percentage cover.</p>
<p>But again, there is a faster way. This will be a common theme for many of the tools you will learn from this week on - they don’t necessarily offer new possibilities of analysis, but they will optimise/facilitate the same analysis with less steps. What separates a GIS user from a good GIS user is knowing which approach is optimal for each situation.</p>
</div>
</div>
</div>
<ol start="7" class="example" type="1">
<li>Go back to the <code>Processing</code> panel and find the <code>Overlap Analysis</code> tool, under the <code>Vector Analysis</code> category, and launch it. This tool only takes two parameters: <code>Input layer</code> is the main layer you want as output (the neighbourhood layer in this case), and the <code>Overlay layers</code> are the layers you want to calculate the overlap with (in our case, only one, the green spaces layer). Set these two parameters and then save your result to a proper location. A new layer will be produced.</li>
</ol>
<p><img src="images/lab_12/lab12_fig2_overlap.jpg" class="img-fluid"></p>
<p>This new layer has all the same attributes and polygons as the original neighbourhoods layer, but two additional fields, named with the name of the overlap layer followed by a <code>_area</code> or <code>_pc</code> suffix: the first gives you the overlap area (in the same units as the CRS you are using, so m<span class="math inline">\(^2\)</span>), and the second gives you the percentage of area overlap. It should look somewhat like this:</p>
<ol start="8" class="example" type="1">
<li>Style this new overlap layer to show the percentage of green spaces as a continuous colour. Does it seem to be inversely correlated to NO<span class="math inline">\(_2\)</span> pollution?</li>
</ol>
</section>
<section id="guided-exercise---sample-raster-values" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="guided-exercise---sample-raster-values"><span class="header-section-number">12.4</span> Guided Exercise - Sample Raster Values</h2>
<p><code>Zonal Statistics</code> lets us sample and summarise raster values based on areas (i.e.&nbsp;polygons). But sometimes, we may be interested in knowing what the specific raster values under a point coordinate are. Again, as a GIS analyst, you have been now asked to determine if NO<span class="math inline">\(_2\)</span> levels have declined between 2008 and 2023. But the point location measurements only go as far back as 2010, so you need to compare the 2023 field measurements to the 2008 modelled values.</p>
<ol start="9" class="example" type="1">
<li><p>Before we proceed with the analysis, we need to link the NO<span class="math inline">\(_2\)</span> measured values (in the CSV file) with the measurement locations (one of the geopackage layers). You can do that using a <code>Join</code>, and the <code>CodeJ</code> field of the CSV table and the <code>Code</code> field of the locations layer.</p></li>
<li><p>Now we can extract the concentration values from the 2008 raster using the <code>Sample Raster Values</code> tool. You will find it in the <code>Processing</code> panel, under the <code>Raster Analysis</code> section. Similarly to the <code>Zonal Statistics</code> tool, you will be asked to select an <code>Input Layer</code> (the vector points) and a <code>Raster Layer</code> (the pollution raster), and to pick a prefix for the field name (we can use <code>NO2_</code> again). Save your result in the appropriate location and click on <code>Run</code> then <code>Close</code>.</p></li>
</ol>
<p><img src="images/lab_12/lab12_fig3_sampleraster.jpg" class="img-fluid"></p>
<ol start="11" class="example" type="1">
<li><p>The new layer created by the <code>Sample raster values</code> tool will be a copy of the input point layer, but will have one additional attribute at the end, named <code>NO2_1</code>. The *_1* refers to the band number. If the raster file had multiple bands, it would generate one column for each band. You can now use the <code>Field calculator</code> to calculate the difference between 2023 and 2008 concentrations as a new decimal number field.</p></li>
<li><p>Style the layer to show the direction and amount of changes in emissions for each neighbourhood, using a divergent continuous colour scale (so that positive changes are shaded in one colour and negative changes as another - you can use the ColorBrewer palettes for that).</p></li>
</ol>
</section>
<section id="independent-exercise---taiwanese-hemlock-and-climate-change" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="independent-exercise---taiwanese-hemlock-and-climate-change"><span class="header-section-number">12.5</span> Independent Exercise - Taiwanese hemlock and climate change</h2>
<section id="background" class="level3" data-number="12.5.1">
<h3 data-number="12.5.1" class="anchored" data-anchor-id="background"><span class="header-section-number">12.5.1</span> Background</h3>
<p>As the GIS specialist for an International NGO (Non-governmental organization), you have been tasked with generating a report on the possible susceptibility of the tree species <a href="https://en.wikipedia.org/wiki/Tsuga_chinensis"><em>Tsuga chinensis</em></a> (Chinese Hemlock or Taiwanese Hemlock) to climate change in <a href="https://en.wikipedia.org/wiki/Taiwan">Taiwan</a>.</p>
<p><img src="images/lab_12/lab12_fig4_tsuga.jpg" class="img-fluid"></p>
</section>
<section id="data-acquisition" class="level3" data-number="12.5.2">
<h3 data-number="12.5.2" class="anchored" data-anchor-id="data-acquisition"><span class="header-section-number">12.5.2</span> Data Acquisition</h3>
<p>For this exercise, I am giving you a pre-downloaded dataset, because the source files are large and also require a registration to download. But I am describing below how to download the original data - <em>you will need it for the Final Project</em> and the information is relevant if working with species distribution data is of interest to you in the future.</p>
<p><a href="https://stir-my.sharepoint.com/:u:/g/personal/ala2_stir_ac_uk/EdX5iTojX65Mv3Jf_DD-PvEBGKnlQIuu7Njo5XFdu4SQmA?e=krTy3W">Download the data package from here</a>.</p>
<p>The first step in your analysis is to obtain data on the distribution of <em>T. chinensis</em>. You go to the main source of species occurrence data worldwide, the <a href="https://www.gbif.org/">Global Biodiversity Species Facility (GBIF)</a>. GBIF requires creating an account to download.</p>
<p>Once you have an account, go to the top left of the webpage and click on <code>Get data &gt; Ocurrences</code>. You can search for data using the different parameters on the left column. Expand the <code>Scientific name</code> field and search for <code>Tsuga chinensis</code>. Then click on <code>Download</code> (above the table). The data will come as a tab-separated text file.</p>
<p>Then you would need climate data. There are many climatic datasets out there, but after doing some research you decide to use the <em>Climatologies at High resolution for the Earth’s Land Surface Areas</em> (CHELSA) database, which provides global maps of past, present and future climate data: <a href="https://chelsa-climate.org/">https://chelsa-climate.org/</a>.</p>
<p>To use this dataset, you need to understand the definition of the standard BIOCLIM variables. These are derived from a different climate dataset called WorldClim, and are a set of climatic descriptors devised to capture climatic conditions that are related to species survival. They are explained here:<a href="https://www.worldclim.org/data/">https://www.worldclim.org/data/bioclim.html</a>. The CHELSA database also provides <em>extended</em> BIOCLIM variables (BIOCLIM+, <a href="https://chelsa-climate.org/exchelsa-extended-bioclim/">https://chelsa-climate.org/exchelsa-extended-bioclim/</a>)for additional important variables.</p>
<p>Since you are working with a plant species, you decide to use the following variables:</p>
<ul>
<li><p><strong>Bio5</strong> = Max Temperature of Warmest Month (upper thermal tolerance)</p></li>
<li><p><strong>Bio6</strong> = Min Temperature of Coldest Month (lower thermal tolerance)</p></li>
<li><p><strong>BIOCLIM+ gsp</strong>* = Growing Season Precipitation Sum, represents water availability during the growing season.</p></li>
<li><p><strong>BIOCLIM+ gdd5</strong> = Growing Degree Days above 5 Degrees Celsius. A ‘growing degree day’ is a day that has temperatures in the needed range for plant growth, and the variable is calculated by summing the temperature of all GDDs.</p></li>
</ul>
<p>You note on the documentation that Bio 5 and Bio 6 are given in degrees Celsius, growing degree days are given as the total heat summed over all growing days, also in Celsius, and growing season precipitation has values in mm of rain.</p>
<p>CHELSA also provides data for future climate analysis, including multiple future date prediction targets, various <a href="https://www.carbonbrief.org/explainer-how-shared-socioeconomic-pathways-explore-future-climate-change/">Shared Socioeconomic Pathways</a> (SSPs, aka climate scenarios), and predictions from different climate models in the <a href="https://www.carbonbrief.org/cmip6-the-next-generation-of-climate-models-explained/">CMPI6 group</a>.</p>
<p>You settle on using projections for the SSP 370 (middle-of-the-road scenario) for the years 2081-2100 prediction, and to restrict your analysis to the average prediction of three climate model outputs:</p>
<p>IPSL-CM6A-LR (<a href="info:%20https://cmc.ipsl.fr/ipsl-climate-models/ipsl-cm6/">https://cmc.ipsl.fr/ipsl-climate-models/ipsl-cm6/</a>)</p>
<p>MPI-ESM1-2-HR (<a href="info:%20https://gmd.copernicus.org/articles/12/3241/2019/">https://gmd.copernicus.org/articles/12/3241/2019/</a>)</p>
<p>MPI-ESM2-0 (<a href="info:%20https://www.jstage.jst.go.jp/article/jmsj/97/5/97_2019-051/_article">https://www.jstage.jst.go.jp/article/jmsj/97/5/97_2019-051/_article</a>)</p>
<p><em>Note: The CHELSA datasets come as global layers, but to reduce download sizes, I have already cropped them to cover Taiwan only. Don’t say I never did anything for you :-).</em></p>
<p>Finally, you decide to grab the Taiwan country borders from the <a href="https://gadm.org/download_country.html">GADM website</a>.</p>
</section>
<section id="data-analysis" class="level3" data-number="12.5.3">
<h3 data-number="12.5.3" class="anchored" data-anchor-id="data-analysis"><span class="header-section-number">12.5.3</span> Data Analysis</h3>
<p>With that data in hand, you are ready to start your project. You prepare an initial list of the tasks you need to accomplish to achieve your goal:</p>
<ol type="1">
<li><p>Organise the data into a folder and then import the data into a QGIS project. You may add OpenStreetMap (from the XYZ Tiles) to help you to recognise where these data are located in the world. Also, open the attribute tables and raster info to understand the structure of each data file, unit, etc.</p></li>
<li><p>Import the <em>T. chinensis</em> species occurrence file. Although it is named CSV, you notice it uses <em>tab</em> as a custom column delimiter. The spatial information is on fields <code>decimalLatitude</code> and <code>decimalLongitude</code>.</p></li>
<li><p>Make sure the project CRS is adequate and that all data uses the same CRS, or reproject if not.</p></li>
<li><p>This exercise focuses on species observation in Taiwan, so clean up all the data to include only records from Taiwan, and only actual observations (e.g.&nbsp;not a specimen in a museum) - i.e.&nbsp;records having the word “observation” on the <code>basisofRec</code> attribute field.</p></li>
<li><p>Use the species occurrence points to extract the minimum and maximum values for each <em>present</em> climate layer, therefore determining the <a href="https://www.usgs.gov/centers/wetland-and-aquatic-research-center/science/climate-envelope-modeling-evaluating">climate envelope</a> of the species. You can then assume that any location where one or more of the climatic variables are outside this range is not suitable for the species’ survival.</p></li>
<li><p>Average the outputs of the three climatic models for each of your future climatic layers.</p></li>
<li><p>Find out which locations in the future will be within the climate envelope you calculated previously. (Hint: an area has to be within the envelope of all four variables to be considered suitable).</p></li>
<li><p>Calculate the total area of suitable habitat expected for <em>T. chinensis</em> in the years 2071-2100, according to the SSP370 scenario, and determine how much smaller/larger it is than the current suitable area.</p></li>
<li><p>Make a nice map showing your results.</p></li>
</ol>
<p>Now that you have a plan in mind, execute it!</p>
<p>GIS operations to consider: Import Delimited Text File, Select by Location, Select by Expression, Sample Raster Values, Raster Calculator, Raster to Vector conversion, Field Calculator.</p>
<p>Obs: this is a very crude method to determine species distribution and niche, but this is a GIS module, not a Biogeography one. If you find this interesting, search for Species Distribution Modelling (SDM) or Environmental Niche Modelling (ENM). It is a well-developed field with specialised tools and methods, which nonetheless are still GIS operations at heart.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./lab_joins.html" class="pagination-link" aria-label="Lab 11 - Data Joins">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Lab 11 - Data Joins</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./sec_w8_spatial_analysis_III.html" class="pagination-link" aria-label="Week 8 - Spatial analysis III">
        <span class="nav-page-text">Week 8 - Spatial analysis III</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>