<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GEOU9SP GIS Workbook - 11&nbsp; Lab 11 - Data Joins</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./lab_zonal.html" rel="next">
<link href="./sec_w6_spatial_analysis_II.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./sec_w6_spatial_analysis_II.html">Week 6 - Spatial analysis II</a></li><li class="breadcrumb-item"><a href="./lab_joins.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Lab 11 - Data Joins</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">GEOU9SP GIS Workbook</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome!</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w1_intro_toGIS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 1 - Introduction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Lab 1: QGIS overview and file management</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_crs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Lab 2: Coordinate Reference Systems</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w2_vectors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 2 - Vector data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_vectors_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Lab 3: Working with vector attributes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_vectors_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Lab 4: Working with vector geometries</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w3_rasters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 3 - Raster data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_rasters_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Lab 5: Working with raster data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_rasters_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Lab 6: The raster calculator and other rastery bits</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w4_cartography.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 4 - Making maps</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_carto_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Lab 7: Making Maps - Part I</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_carto_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Lab 8: Making Maps - Part II</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w5_spatial_analysis_I.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 5 - Spatial analysis I</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_catchup1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Lab 9 - Catch Up / Assignment Work session</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_geoprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Lab 10: Geoprocessing tools</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w6_spatial_analysis_II.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 6 - Spatial analysis II</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_joins.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Lab 11 - Data Joins</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_zonal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab 12 - Zonal Statistics and Overlap Analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./sec_w8_spatial_analysis_III.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 8 - Spatial analysis III</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_dist_dens.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Lab 13 - Densities and distances</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab_convex_interp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Lab 14 - Convex Hulls</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Week 10 - Obtaining spatial data in the field</span></span>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#guided-exercise-1---working-with-wfs-layers." id="toc-guided-exercise-1---working-with-wfs-layers." class="nav-link active" data-scroll-target="#guided-exercise-1---working-with-wfs-layers."><span class="header-section-number">11.1</span> Guided Exercise 1 - Working with WFS layers.</a></li>
  <li><a href="#guided-exercise-2---importing-tabular-data" id="toc-guided-exercise-2---importing-tabular-data" class="nav-link" data-scroll-target="#guided-exercise-2---importing-tabular-data"><span class="header-section-number">11.2</span> Guided Exercise 2 - Importing tabular data</a></li>
  <li><a href="#guided-exercise-3---table-joins" id="toc-guided-exercise-3---table-joins" class="nav-link" data-scroll-target="#guided-exercise-3---table-joins"><span class="header-section-number">11.3</span> Guided Exercise 3 - Table Joins</a></li>
  <li><a href="#guided-exercise-4---spatial-joins" id="toc-guided-exercise-4---spatial-joins" class="nav-link" data-scroll-target="#guided-exercise-4---spatial-joins"><span class="header-section-number">11.4</span> Guided Exercise 4 - Spatial Joins</a></li>
  <li><a href="#independent-exercise-1---counting-points-in-polygons" id="toc-independent-exercise-1---counting-points-in-polygons" class="nav-link" data-scroll-target="#independent-exercise-1---counting-points-in-polygons"><span class="header-section-number">11.5</span> Independent Exercise 1 - Counting points in polygons</a></li>
  <li><a href="#independent-exercise-2---practicing-joins" id="toc-independent-exercise-2---practicing-joins" class="nav-link" data-scroll-target="#independent-exercise-2---practicing-joins"><span class="header-section-number">11.6</span> Independent Exercise 2 - Practicing Joins</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./sec_w6_spatial_analysis_II.html">Week 6 - Spatial analysis II</a></li><li class="breadcrumb-item"><a href="./lab_joins.html"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Lab 11 - Data Joins</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-spatan2" class="quarto-section-identifier"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Lab 11 - Data Joins</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this lab we will learn about <em>data joins</em> - operations that link data tables based on specific attributes, or based on locations. We will also learn how to read tabular data which has coordinates as columns but is not actual spatial dataset, and will learn about Web Feature Service (WCS) layers - a standardized way to <em>stream</em> geospatial data without having to download it. Don’t skip the <em>Independent Exercise</em> either - you will learn two bonus GIS tools as part of it!</p>
<section id="guided-exercise-1---working-with-wfs-layers." class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="guided-exercise-1---working-with-wfs-layers."><span class="header-section-number">11.1</span> Guided Exercise 1 - Working with WFS layers.</h2>
<p>Both WFS (Web Feature Services), WMS (Web Map Services), and WCS (Web Coverage Services) are standardised web sharing formats defined by the <a href="https://www.ogc.org/">Open Geospatial Consortium (OGC)</a>. WMS and WCS are designed to serve images (i.e.&nbsp;rasters), while WFS is designed to serve features (i.e.&nbsp;vectors). This is similar to the streaming of Google Maps or Open Street Maps you have used with QGIS already, with the difference that layers streamed via WFS function just like layers you download to your computer.</p>
<p>The advantage of these formats is that you can connect direct with the data provider without having to download the data to disk first - but that is also the disadvantage, since if you lose internet connection you then have no data. More and more data providers are offering these options, so we will explore one example of a WFS layer here, and use it for the rest of the exercises.</p>
<ol class="example" type="1">
<li><p>Create a <code>lab_11</code> folder to organise your data and then start a new QGIS project and save it as <code>lab_11</code>. Set the project CRS to EPSG:27700.</p></li>
<li><p>The Scotland Spatial Hub <a href="https://data.spatialhub.scot/">https://data.spatialhub.scot/</a> hosts official datasets from the Scotland Government. One of the layers is a vector file with the administrative boundaries for Scotland, the Scotland Council Areas. We can access this dataset via WFS. First, copy the link below:</p></li>
</ol>
<p>https://geo.spatialhub.scot/geoserver/sh_las/wfs?authkey=b85aa063-d598-4582-8e45-e7e6048718fc</p>
<ol start="3" class="example" type="1">
<li>Now on the <code>Browser</code> panel of QGIS, find the <code>WFS / OGC API Features</code> option, then right-click on it and select <code>New Connection</code>:</li>
</ol>
<p><img src="images/lab_11/lab_11_fig_1_WFS_new.jpg" class="img-fluid"></p>
<ol start="4" class="example" type="1">
<li>You will get a new window. On this new window, paste the link above on the <code>URL</code> box, and then type <code>Scotland Spatial Hub</code> on the <code>Name</code> box. Then click <code>OK</code>.</li>
</ol>
<p><img src="images/lab_11/lab_11_fig_2_WFS_config.jpg" class="img-fluid"></p>
<ol start="5" class="example" type="1">
<li><p>You should now have a new <code>Scotland Spatial Hub</code> entry under <code>WFS / OGC API Features</code> on the <code>Browser</code> panel. Expand it and double-click on <code>Local Authority Boundaries - Scotland</code>. It will add this layer to your <code>Layers</code> panel.</p></li>
<li><p>Inspect the attribute table of this layer, and play with its <code>Symbology</code>. You will see it behaves exactly like a downloaded shapefile or geopackage. Just remember you must have an internet connection for it to be available - and some operations will feel slower, since it has to communicate back and forth with the data server.</p></li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can always make the WFS layer ‘local’ by right-clicking on it and selecting <code>Export &gt; Save Feature As...</code>, and then saving a copy of it as a shapefile or geopackage.</p>
</div>
</div>
</section>
<section id="guided-exercise-2---importing-tabular-data" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="guided-exercise-2---importing-tabular-data"><span class="header-section-number">11.2</span> Guided Exercise 2 - Importing tabular data</h2>
<p>Sometimes you may have data that has coordinate information, but it is not in a spatial file format. For example, perhaps someone took soil samples along a beach and manually recorded the sampling locations by writing down the coordinates from a GPS receiver. We can still transform this data into spatial data - as long as we know which the CRS used to record the coordinates was. This is often a big problem, as people that are not GIS savvy (like yourself) do not understand CRSs and just write down the coordinates.</p>
<p>Another common issue is that people will see coordinates like -5.67543 degrees on the GPS device, and then round it down when writing. But (at the equator) one degree of latitude/longitude is about 111km, so if you round down the above coordinate to -5.67, you are rounding it up to the nearest 1km, and introducing a huge error.</p>
<p>In this exercise, we will import some data from Police Scotland about traffic incidents, which is provided in tabular format.</p>
<ol start="7" class="example" type="1">
<li>To obtain the data, follow <a href="https://www.scotland.police.uk/about-us/how-we-do-it/road-traffic-collision-data/">this link to the Police Scotland website</a>. Then download the <em>Road Traffic Collisions - Circumstances Raw Data</em> dataset, which should be an Excel file (<code>.xsls</code>).</li>
</ol>
<p>QGIS is not able to understand Excel files, so we need to convert it to a <em>Comma Separated Value (CSV)</em> file. A CSV is just a plain text file where each line is a row on the table, and the data for each column is separated by…you guess it…a comma (actually sometimes it is a semicolon - especially in countries that use the comma instead of the period as a decimal separator).</p>
<ol start="8" class="example" type="1">
<li><p>Open the file you downloaded in Excel. The first thing you’ll notice is that they have a VERY professional way of marking the data as official - a floating red text box saying ‘official’. Delete this box, then go to <code>File &gt; Save As</code> and then change the save format from <code>Excel workbook (.xlsx)</code> to <code>CSV UTF-8 (Comma Separated Value) (.csv)</code>. You can save it with the same name on the same folder you downloaded it.</p></li>
<li><p>Open the <code>Notepad</code> application (on Windows, on Mac use <code>TextEdit</code>) and then open the csv file you created, just to see how a CSV file is organized. Then close it.</p></li>
<li><p>Back on QGIS (in your <code>lab_11</code> project), open the <code>Data Source Manager</code> by clicking on the <img src="https://docs.qgis.org/3.34/en/_images/mActionDataSourceManager.png" class="img-fluid"> button on the main QGIS toolbar. Then pick the option <code>Delimited Text</code>. On the top box, find the <code>.csv</code> file you have created. Then make sure your options look the same as the figure below, including picking the correct data type for <code>date_of_collision</code> (<code>date</code>) and <code>time_of_collision</code> (<code>time</code>). Once you have everything set, click on <code>Add</code>, then <code>Close</code>.</p></li>
</ol>
<p><img src="images/lab_11/lab_11_fig_3_data_source_manager.jpg" class="img-fluid"></p>
<ol start="11" class="example" type="1">
<li><p>You should now see a new layer in your project, with the same name as the CSV file, and a number of different data points that roughly form the shape of Scotland. Inspect the attribute table of this new layer, and pay attention to the name of the last attribute column in the dataset.</p></li>
<li><p>At this point QGIS is still reading the data straight from the CSV, which is not very efficient. Let us save the data by right-clicking on the layer name and going to <code>Export &gt; Save Features As...</code> and saving it as a geopackage. You can then remove the imported csv layer from the project.</p></li>
</ol>
</section>
<section id="guided-exercise-3---table-joins" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="guided-exercise-3---table-joins"><span class="header-section-number">11.3</span> Guided Exercise 3 - Table Joins</h2>
<p>We now have two separate layers with separate data tables - the Local Authority boundaries and the Traffic Accidents. But they share an attribute in common: <code>local_authority</code> in the former and <code>GIS_Local_Authority</code> in the latter. We can use these attributes to <em>join</em> the two tables.</p>
<ol start="13" class="example" type="1">
<li>Right-Click on the Traffic Accidents layer and go to <code>Properties &gt; Joins</code>. Then click on the green plus button at the bottom to create a new join. A new window will appear - pick the Local Authority layer as <code>Join Layer</code>, and <code>local_authority</code> as the <code>Join field</code> (notice these are the attributes of the Local Authority layer). Then pick <code>GIS_Local_Authority</code> as the <code>Target field</code> (notice these are the attributes of the traffic layer). It should look like the figure below. Click <code>OK</code> on this window and notice a new join has been added. Click <code>OK</code> again.</li>
</ol>
<p><img src="images/lab_11/lab_11_fig_4_newjoin.jpg" class="img-fluid"></p>
<ol start="14" class="example" type="1">
<li>Open the attribute table of the traffic collision layer again. Look at the last attribute columns of the table - there should now be two additional columns, showing the <code>code</code> and <code>hectares</code> fields of the Local Authority layer! Notice that while the Local Authority Layer only has one row per Authority area, the respective values of <code>code</code> and <code>hectare</code> are repeated for all traffic incidents occurring in the same Authority area.</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled" title="Stop and Think">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stop and Think
</div>
</div>
<div class="callout-body-container callout-body">
<p>On the joined attribute table of the Traffic Collisions layer, the local authorities of Dumfries &amp; Galloway, Argyll &amp; Bute, Perth &amp; Kinross and Eilean Siar have all <code>code</code> and <code>hectare</code> fields as <code>NULL</code>, while they seem fine on the Local Authority attribute table. Can you identify what the problem is?</p>
</div>
</div>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="Click for answer">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click for answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The main issue is that computers are dumb :-). Dumfries &amp; Galloway, Argyll &amp; Bute, and Perth &amp; Kinross are spelled with an <code>&amp;</code> on the Traffic Collision layer but with an <code>and</code> on the Local Authority layer, and Eilean Siar (the Outer Hebrides) is spelled as Na h-Eileanan an Ia. As far as the computer is concerned, these things are not the same, and so it does not make the join for these data rows. This is a classic example of the many small data inconsistencies that need to be fixed when working with real-world data.</p>
</div>
</div>
</div>
</section>
<section id="guided-exercise-4---spatial-joins" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="guided-exercise-4---spatial-joins"><span class="header-section-number">11.4</span> Guided Exercise 4 - Spatial Joins</h2>
<p>You may be tempted to fix the problem above by using the <code>Field Calculator</code> to replace the spelling on one table by the spelling on the other. But there is another way - using a <em>spatial join</em> instead of an attribute join. Just like you can select data rows by attribute or by location, you can also join data tables by either attributes or location. Let’s do it.</p>
<ol start="15" class="example" type="1">
<li><p>First, remove the attribute join your created before. Go to the <code>Properties &gt; Joins</code> of the Traffic Collision layer, select the existing join and remove it using the red minus symbol. Then click <code>OK</code>.</p></li>
<li><p>No go to the menu <code>Vector &gt; Data Management Tools &gt; Join Attributes by Location...</code>. You will see a new window similar to the <code>Select by Location</code> window. Then specify you want to <code>Join features in</code> the Traffic Collision layer that <code>Are Within</code> the Local Authority layer. Because there are many traffic incidents for each Authority area, you want to keep the <code>Join type</code> as <code>one-to-many</code>. For reference, check the figure below. This operation creates a new layer containing the joined table, so pick a folder and save your result as a vector file named <code>traffic_collisions_authority_joined</code>, then click <code>Run</code> followed by <code>Close</code>.</p></li>
</ol>
<p><img src="images/lab_11/lab_11_fig_5_spatial_join.jpg" class="img-fluid"></p>
<ol start="17" class="example" type="1">
<li>Check the attribute table of the new joined layer you created. There should now be three new columns at the end - the three columns from the Local Area layer: <code>local_authority</code>, <code>code</code> and <code>hectares</code> (when we join by attribute QGIS knows not to repeat the matching field, so it only brings in <code>code</code> and <code>hectare</code> - but when we join by location then it brings all attributes).</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled" title="Stop and Think">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Stop and Think
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can see that for most cases our Spatial Join fixed the name mismatch issues, and we see values of <code>GIS_Local_Authorities</code> like <code>Dumfries &amp; Galloway</code> matched to <code>local_authority</code> values like <code>Dumfries and Galloway</code>. But if you sort your joined attributed table by <code>local_authority</code>, you will see there are now 11 rows with <code>NULL</code> values. Can you identify the problem this time?</p>
</div>
</div>
<div class="callout callout-style-simple callout-important no-icon callout-titled" title="Click for answer">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Click for answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>These 11 traffic incidents may have been recorded with wrong or uncertain coordinates, and they fall ‘outside’ of the Local Authority polygons. For example, manually select the row for Dundee City (click on the row number) and then click on the <code>Zoom Map to Select Rows</code> button (at the top of the attribute table, looks like a magnifying glass). The check the QGIS map canvas, and you will see this data point is located over water, so it is not joined to any Authority polygon - maybe a boat traffic incident?</p>
</div>
</div>
</div>
</section>
<section id="independent-exercise-1---counting-points-in-polygons" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="independent-exercise-1---counting-points-in-polygons"><span class="header-section-number">11.5</span> Independent Exercise 1 - Counting points in polygons</h2>
<p>In this exercise, you will practice using joins and spatial joins, and will also independently learn another two GIS tools: <code>Count Points in Polygons</code> (<a href="https://docs.qgis.org/3.34/en/docs/user_manual/processing_algs/qgis/vectoranalysis.html#count-points-in-polygon">QGIS Documentation</a>) and <code>Statistics by Categories</code> (<a href="https://docs.qgis.org/3.34/en/docs/user_manual/processing_algs/qgis/vectoranalysis.html#qgisstatisticsbycategories">QGIS Documentation</a>).</p>
<p>You have been tasked with calculating a) the total amount of traffic incidents and b) the rate of incidents per capita, for all census Output Areas. To achieve that, together with the Traffic Collision layer you already have, you have been given a shapefile with the boundaries of the census Output Areas, and a csv file with the population information for each Output Area (<a href="https://stir-my.sharepoint.com/:u:/g/personal/ala2_stir_ac_uk/EbDVBY1vzPFFmXze9NnPAXMB_5agSBMugN0pEkmlDoBo1w?e=FcK74N">download them here</a>)</p>
<ol type="1">
<li><p>Download, extract and organise your files, and start a new project.</p></li>
<li><p>Load the data into QGIS. The CSV file doesn’t have any coordinates, so you can just drag it and drop it in the <code>Layers</code> panel. It will show up as a non-spatial table (no geometries to show, but still has an attribute table).</p></li>
<li><p>Guess what? The Output Area shapefile has topology errors. Use the <code>Fix Geometries</code> tool (<code>Procesing</code> panel, under the <code>Vector Geometry</code> category) to create a new shapefile with fixed geometries. Once you create it, rebuild the spatial index of this new fixed layer by going to <code>Vector &gt; Data Management Tools &gt; Create Spatial Index</code>. Otherwise, your next step will be very slow.</p></li>
<li><p>Now do a <em>spatial join</em> between the fixed OA layer and the Traffic Collision layer. You want to join features from the traffic collision that <code>are within</code> the OAs. Save this new result as a new layer.</p></li>
<li><p>Your resulting layer should now have all the traffic collisions joined to their respective OA codes. Now use the <code>Statistics by Categories</code> tool to count how many traffic collisions per Output Area code. The tool is in the <code>Processing</code> panel, under the <code>Vector Analysis</code> category. You want to calculate the counts, using the <code>code</code> attribute as the category for calculation. The window should look like this:</p></li>
</ol>
<p><img src="images/lab_11/lab_11_fig_6_stats_by_cats.jpg" class="img-fluid"></p>
<ol start="6" type="1">
<li>The output of the above step will be another non-spatial table. Join this table to the OA polygons using <code>code</code> as the common attribute - the OA layer should be one receiving the join. Then do a second join to bring in the age data from the CSV file as well. For this join, bring only the <code>ALl_people</code> field from the csv file - enable the <code>Joined fields</code> box on the new join window, and then check only the box for <code>ALl_people</code>. Your attribute table now should look like this:</li>
</ol>
<p><img src="images/lab_11/lab_11_fig_7_double_join.jpg" class="img-fluid"></p>
<ol start="7" type="1">
<li><p>The <code>Statistics_by_category_count</code> attribute answers question a) above - total number of traffic collisions per OA. To answer question b), use the <code>Field calculator</code> to divide this number by <code>All_people</code>, to get the total collisions per capita.</p></li>
<li><p>Because you only wanted counts of points to answer a), there is a simpler alternative to joining then summarising. Go to <code>Vector &gt; Analysis Tools &gt; Count Points in Polygons</code>. The pick the (fixed) Output Area polygons as your <code>Polygons</code> and the Traffic Collisions layer as your <code>Points</code>, then save and run the results. You will see it calculates a new column named <code>NUMPOINTS</code>. You could then do a table join of this layer to the CSV table to get the <code>All_people</code> column, and answer question b). There are often multiple ways to achieve the same result in GIS!</p></li>
<li><p>Make two visualisations of the results: one colouring the OA polygons by the number of total collisions, and another by the total collisions per capita.</p></li>
</ol>
</section>
<section id="independent-exercise-2---practicing-joins" class="level2" data-number="11.6">
<h2 data-number="11.6" class="anchored" data-anchor-id="independent-exercise-2---practicing-joins"><span class="header-section-number">11.6</span> Independent Exercise 2 - Practicing Joins</h2>
<p>First, <a href="https://stir-my.sharepoint.com/:u:/g/personal/ala2_stir_ac_uk/EUBu4Ns8Rw5NskcNdkV9_oEBCu1LwAEV8HyFA3NQksyvvA?e=Jb5Fl9">download the data files from here</a>. They contain population information per Council Area for Scotland from the 2011 and 2022 census, respectively.</p>
<ol type="1">
<li><p>Add the CSV data to QGIS as non-spatial layers (tables).</p></li>
<li><p>Add the “Local Authority Boundaries” WFS layer from Guided Exercise 1</p></li>
<li><p>Join the Census 2011 layer to the Local Authority layer using the fields ‘Scottish Council Area’ and ‘local_authority’. Select only the columns ‘All people’, ‘Males’ and ‘Females’. Also toggle the Custom field name prefix option and type ‘2011_’.</p></li>
<li><p>Now repeat the process to join the same three columns from the 2022 data. Don’t forget to use the ‘2022_’ prefix to distinguish them from the 2011 data.</p></li>
<li><p>Export the joined data as a new Geopackage or Shapefile file.</p></li>
<li><p>Make three thematic visualisations of the following information:</p>
<ul>
<li>The total change in population per Council Area between 2011 and 2022.</li>
<li>The total change in population density (people/km2) per Council Area between 2011 and 2022.</li>
<li>The change in sex ratios (male/female) per Council Area between 2011 and 2022.</li>
</ul></li>
<li><p>One of the measures for quality of life and healthy living is access to green spaces. Using the population census layer you created, and the <a href="https://osdatahub.os.uk/downloads/open/OpenGreenspace">OS Open Greenspaces dataset</a>, calculate how many m<span class="math inline">\(^2\)</span> of green space are available per capita for each Council Area in Scotland, and make a map showing this result.</p></li>
</ol>
<div class="callout callout-style-simple callout-tip no-icon callout-titled" title="Hint">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Hint
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Hint: You will need to do two separate joins: one to add the corresponding Council Area Name to each green space entry. Then you will need to calculate the total green space area per CA using the Statistics by Category tool. You can then join the Area attribute of this new layer to the original Local Authority attribute table containing the joined census data, and then calculate the proportions as a new field.</p>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./sec_w6_spatial_analysis_II.html" class="pagination-link" aria-label="Week 6 - Spatial analysis II">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Week 6 - Spatial analysis II</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./lab_zonal.html" class="pagination-link" aria-label="Lab 12 - Zonal Statistics and Overlap Analysis">
        <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Lab 12 - Zonal Statistics and Overlap Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>